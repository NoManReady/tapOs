var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(n,q,r){n instanceof String&&(n=String(n));for(var u=n.length,m=0;m<u;m++){var h=n[m];if(q.call(r,h,m,n))return{i:m,v:h}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(n,q,r){n!=Array.prototype&&n!=Object.prototype&&(n[q]=r.value)};$jscomp.getGlobal=function(n){return"undefined"!=typeof window&&window===n?n:"undefined"!=typeof global&&null!=global?global:n};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(n,q,r,u){if(q){r=$jscomp.global;n=n.split(".");for(u=0;u<n.length-1;u++){var m=n[u];m in r||(r[m]={});r=r[m]}n=n[n.length-1];u=r[n];q=q(u);q!=u&&null!=q&&$jscomp.defineProperty(r,n,{configurable:!0,writable:!0,value:q})}};$jscomp.polyfill("Array.prototype.find",function(n){return n?n:function(n,r){return $jscomp.findInternal(this,n,r).v}},"es6","es3");
var CryptoJS=CryptoJS||function(n,q){var r={},u=r.lib={},m=u.Base=function(){function h(){}return{extend:function(m){h.prototype=this;var p=new h;m&&p.mixIn(m);p.hasOwnProperty("init")||(p.init=function(){p.$super.init.apply(this,arguments)});p.init.prototype=p;p.$super=this;return p},create:function(){var p=this.extend();p.init.apply(p,arguments);return p},init:function(){},mixIn:function(p){for(var h in p)p.hasOwnProperty(h)&&(this[h]=p[h]);p.hasOwnProperty("toString")&&(this.toString=p.toString)},
clone:function(){return this.init.prototype.extend(this)}}}(),h=u.WordArray=m.extend({init:function(p,h){p=this.words=p||[];this.sigBytes=h!=q?h:4*p.length},toString:function(p){return(p||A).stringify(this)},concat:function(p){var h=this.words,m=p.words,l=this.sigBytes;p=p.sigBytes;this.clamp();if(l%4)for(var n=0;n<p;n++)h[l+n>>>2]|=(m[n>>>2]>>>24-n%4*8&255)<<24-(l+n)%4*8;else if(65535<m.length)for(n=0;n<p;n+=4)h[l+n>>>2]=m[n>>>2];else h.push.apply(h,m);this.sigBytes+=p;return this},clamp:function(){var h=
this.words,m=this.sigBytes;h[m>>>2]&=4294967295<<32-m%4*8;h.length=n.ceil(m/4)},clone:function(){var h=m.clone.call(this);h.words=this.words.slice(0);return h},random:function(m){for(var p=[],l=0;l<m;l+=4)p.push(4294967296*n.random()|0);return new h.init(p,m)}}),w=r.enc={},A=w.Hex={stringify:function(h){var m=h.words;h=h.sigBytes;for(var l=[],p=0;p<h;p++){var n=m[p>>>2]>>>24-p%4*8&255;l.push((n>>>4).toString(16));l.push((n&15).toString(16))}return l.join("")},parse:function(m){for(var l=m.length,
p=[],n=0;n<l;n+=2)p[n>>>3]|=parseInt(m.substr(n,2),16)<<24-n%8*4;return new h.init(p,l/2)}},F=w.Latin1={stringify:function(h){var m=h.words;h=h.sigBytes;for(var l=[],p=0;p<h;p++)l.push(String.fromCharCode(m[p>>>2]>>>24-p%4*8&255));return l.join("")},parse:function(m){for(var l=m.length,p=[],n=0;n<l;n++)p[n>>>2]|=(m.charCodeAt(n)&255)<<24-n%4*8;return new h.init(p,l)}},l=w.Utf8={stringify:function(h){try{return decodeURIComponent(escape(F.stringify(h)))}catch(x){throw Error("Malformed UTF-8 data");
}},parse:function(h){return F.parse(unescape(encodeURIComponent(h)))}},I=u.BufferedBlockAlgorithm=m.extend({reset:function(){this._data=new h.init;this._nDataBytes=0},_append:function(h){"string"==typeof h&&(h=l.parse(h));this._data.concat(h);this._nDataBytes+=h.sigBytes},_process:function(m){var l=this._data,p=l.words,q=l.sigBytes,u=this.blockSize,A=q/(4*u);A=m?n.ceil(A):n.max((A|0)-this._minBufferSize,0);m=A*u;q=n.min(4*m,q);if(m){for(var r=0;r<m;r+=u)this._doProcessBlock(p,r);r=p.splice(0,m);l.sigBytes-=
q}return new h.init(r,q)},clone:function(){var h=m.clone.call(this);h._data=this._data.clone();return h},_minBufferSize:0});u.Hasher=I.extend({cfg:m.extend(),init:function(h){this.cfg=this.cfg.extend(h);this.reset()},reset:function(){I.reset.call(this);this._doReset()},update:function(h){this._append(h);this._process();return this},finalize:function(h){h&&this._append(h);return this._doFinalize()},blockSize:16,_createHelper:function(h){return function(m,l){return(new h.init(l)).finalize(m)}},_createHmacHelper:function(h){return function(m,
l){return(new B.HMAC.init(h,l)).finalize(m)}}});var B=r.algo={};return r}(Math);
(function(){var n=CryptoJS,q=n.lib,r=q.WordArray,u=q.Hasher,m=[];q=n.algo.SHA1=u.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(h,n){for(var q=this._hash.words,u=q[0],l=q[1],r=q[2],w=q[3],p=q[4],x=0;80>x;x++){if(16>x)m[x]=h[n+x]|0;else{var y=m[x-3]^m[x-8]^m[x-14]^m[x-16];m[x]=y<<1|y>>>31}y=(u<<5|u>>>27)+p+m[x];y=20>x?y+((l&r|~l&w)+1518500249):40>x?y+((l^r^w)+1859775393):60>x?y+((l&r|l&w|r&w)-1894007588):y+((l^r^
w)-899497514);p=w;w=r;r=l<<30|l>>>2;l=u;u=y}q[0]=q[0]+u|0;q[1]=q[1]+l|0;q[2]=q[2]+r|0;q[3]=q[3]+w|0;q[4]=q[4]+p|0},_doFinalize:function(){var h=this._data,m=h.words,n=8*this._nDataBytes,q=8*h.sigBytes;m[q>>>5]|=128<<24-q%32;m[(q+64>>>9<<4)+14]=Math.floor(n/4294967296);m[(q+64>>>9<<4)+15]=n;h.sigBytes=4*m.length;this._process();return this._hash},clone:function(){var h=u.clone.call(this);h._hash=this._hash.clone();return h}});n.SHA1=u._createHelper(q);n.HmacSHA1=u._createHmacHelper(q)})(this);
(function(n,q){"function"!==typeof define||!define.amd||"undefined"!=typeof nonUseAmd&&nonUseAmd?q():"undefined"!=typeof HTMLDev&&HTMLDev?define(["./core/kinggrid.plus"],q):define(["./core/kinggrid.plus.min"],q)})(window,function(n){function q(a){a=JSON.stringify(a);return A?a.replace(/\\u([0-9a-fA-F]{2,4})/g,function(a,d){return String.fromCharCode(parseInt(d,16))}):a}function r(a,b,d){var e=[],g={};for(h in a){var f={},k=a[h];l.is("String",k)&&0!=k.indexOf("ey")?(f["b64_"+h]=a[h],e.push(f)):g[h]=
k}var t=[];(function(a){for(var b in a)t.push((new c(b,a[b])).load(c.options))})(g);if(a=e.length){g=c.options.signSize||5;var h=Math.ceil(a/g);for(f=1;f<=h;f++){k=g*(f-1);var n=g*f>a?a:g*f;G=m.surry(c.options.serverUrl);G.request(c.options.b64Url,e.slice(k,n)).ret(function(a){if(a.result)for(var b in a){if(0==b.indexOf("b64_")){var d=a[b];l.is("String",d)&&(d=JSON.parse(d));t.push((new c(b.substring(4),d)).load(c.options))}}else c.prototype.error.call(null,a)})}}G.fin(function(a,e,c){b&&b(1==t.length?
t[0]:t);d&&d()})}var u=window,m=u.kinggrid,h=window.jQuery,w=window.kingPlus,A=!1;u.JSON&&(A='{"x":"\u4e2d"}'!==u.JSON.stringify({x:"\u4e2d"}));var F=!0;try{u.document.createElement("canvas").getContext("2d")}catch(a){F=!1}var l=m.Utils,I=h(window),B=h(document);n=document.documentElement;var p=!!("minWidth"in n.style)&&"onlosecapture"in n,x="setCapture"in n,y,H,O=function(a){y&&(a=a.originalEvent?a.originalEvent.touches.item(0):a.touches.item(0));return a},N=function(a){this.start=h.proxy(this.start,
this);this.over=h.proxy(this.over,this);this.end=h.proxy(this.end,this);this.onstart=this.onover=this.onend=h.noop;H||(y="mousedown"!=a.type,H={start:y?"touchstart":"mousedown",over:y?"touchmove":"mousemove",end:y?"touchend":"mouseup"})};N.prototype={start:function(a){a=this.startFix(a);z.trigger("dragStart",this,a);B.on(H.over,this.over).on(H.end,this.end);this.onstart(a);return!1},over:function(a){a=this.overFix(a);z.trigger("dragOver",this,a);this.onover(a);return!1},end:function(a){a=this.endFix(a);
z.trigger("dragEnd",this,a);B.off(H.over,this.over).off(H.end,this.end);this.onend(a);return!1},startFix:function(a){a=O(a);this.target=h(a.target);this.selectstart=function(){return!1};B.on("selectstart",this.selectstart).on("dblclick",this.end);if(p)this.target.on("losecapture",this.end);else I.on("blur",this.end);x&&this.target[0].setCapture();return a},overFix:function(a){return a=O(a)},endFix:function(a){a=O(a);B.off("selectstart",this.selectstart).off("dblclick",this.end);p?this.target.off("losecapture",
this.end):I.off("blur",this.end);x&&this.target[0].releaseCapture();return a}};N.create=function(a,b,d,e){var c=h(a),f=new N(b),k=H.start,t=function(){},m=a.className.replace(/^\s|\s.*/g,"")+"-drag-start",l=c[0].style,C,n,p,q,r=B.scrollLeft(),u=B.scrollTop(),J=0==e.left?0:e.left+c.width()-r,v=e.right-r,w=e.top-u,x=0==e.bottom?0:e.bottom-c.height()-u,y=0,Q=0,z=parseInt(l.left),A=parseInt(l.top),R=z,E=A,F=z,G=A;d&&(R=parseInt(l.marginLeft),E=parseInt(l.marginTop),F=R,G=E);var D={onstart:t,onover:t,
onend:t,off:function(){c.off(k,f.start)}},K={scale:function(){var a=1,b=c.parents(".kg-translate");null!=b&&(b=b.css("transform"),null!=b&&(b=b.split("(")[1].split(")")[0].split(","),a=b[0],b=b[3],a=Math.max(Math.sqrt(a*a),Math.sqrt(b*b))));return a}};f.onstart=function(b){var d="fixed"===c.css("position"),e=B.scrollLeft(),f=B.scrollTop(),g=c.width(),k=c.height();g*=K.scale();k*=K.scale();n=C=0;p=d?I.width()-g+C:B.width()-g;q=d?I.height()-k+n:B.height()-k;k=c.offset();g=this.startLeft=d?k.left-e:
k.left;d=this.startTop=d?k.top-f:k.top;this.clientX=b.clientX;this.clientY=b.clientY;k=c.parent();k.is("body")||(y=k[0].getBoundingClientRect().left+e,Q=k[0].getBoundingClientRect().top+f);e=b.clientX-c.offset().left+e-c.width();f=b.clientY-c.offset().top+f;0!=J?J+=e:J;0!=v?v+=e:v;0!=w?w+=f:w;0!=x?x+=f:x;c.addClass(m);D.onstart.call(a,b,g,d)};f.onover=function(b){var e=b.clientX,f=b.clientY;0!=J&&b.clientX<=J&&(e=J);0!=v&&b.clientX>=v&&(e=v);0!=w&&b.clientY<=w&&(f=w);0!=x&&b.clientY>=x&&(f=x);e=e-
this.clientX+this.startLeft;f=f-this.clientY+this.startTop;var g=c[0].style;e=Math.max(C,Math.min(p,e));f=Math.max(n,Math.min(q,f));d?(e=g.marginLeft=(e-y-z)/K.scale()+"px",f=g.marginTop=(f-Q-A)/K.scale()+"px"):(e=g.left=(e-y)/K.scale()+"px",f=g.top=(f-Q)/K.scale()+"px");F=parseInt(e);G=parseInt(f);D.onover.call(a,b,e,f)};f.onend=function(b){var e=c.position(),f=e.left;e=e.top;c.removeClass(m);var g=c[0].style,k=!0;6>Math.abs(F-R)&&6>Math.abs(G-E)&&(k=!1);d?D.onend.call(a,b,k,g.marginLeft,g.marginTop):
D.onend.call(a,b,k,f,e)};f.off=function(){c.off(k,f.start)};if(b)f.start(b);else c.on(k,f.start);return D};n=m.Listener;var E=function(){};h.extend(E.prototype,n.prototype);var D=function(){};D.className=D.name||"SealService";l.inherit(D,E);h.extend(D.prototype,{loadSeal:function(){throw Error("must impl");},saveLog:function(){},verifyPwd:function(){throw Error("must impl");}});var L=function(){};L.className=L.name||"CertService";l.inherit(L,E);h.extend(L.prototype,{sign:function(){throw Error("must impl");
},verifySign:function(){throw Error("must impl");}});E=function(){};h.extend(E.prototype,{getAttr:function(a){return this[a]},setAttr:function(a){var b=this;h.each(a,function(a,e){if("function"===typeof b[a])b[a](e);else b[a]=e})},removeAttr:function(a){delete this[a]}});var c=function(a,b){var d=this;d.signatureid=a;d.setSignatureData(b);d.on("load",function(){c.list[a]=this});d.on("remove",function(a){a=d._getLogInfo(l.extend(a||{},{LOGTYPE:"00",LOGSORT:"14",LOGMEMO:"\u64a4\u9500\u7b7e\u7ae0\u6210\u529f"}));
d.sealService.saveLog(a);delete c.list[d.signatureid]});d.on("update",function(a){"signMeta"===d._item&&(a=d._getLogInfo(l.extend(a||{},{LOGTYPE:"00",LOGSORT:"304",LOGMEMO:"\u6570\u5b57\u7b7e\u540d\u6210\u529f"})),d.sealService.saveLog(a))});d.on("fireremove",function(){c.removeList.push(d.signatureid)});d.on("fireupdate",function(){for(var a=!1,b=0;b<c.updateList.length;b++)if(c.updateList[b]===d){a=!0;break}a||c.updateList.push(d)});for(var e in c)c.hasOwnProperty(e)&&0==e.indexOf("on")&&(this[e]=
c[e]);return this},S=function(a,b,d){if(F){var e=u.document.createElement("canvas");e.height=d;e.width=b;var c=e.getContext("2d"),f=new Image;f.src=a;f.onload=function(){c.drawImage(f,0,0,b,d)}}else e=u.document.createElement("img"),e.style.width=b+"px",e.style.height=d+"px",e.setAttribute("src",a);return e};l.inherit(c,E);h.extend(c.prototype,n.prototype);h.extend(c.prototype,{hashAlg:"sha1",encryptAlg:"RSA",_init:function(){},_getLogInfo:function(a){var b=decodeURIComponent(window.location.href),
d=this.signatureData;return l.extend(a||{},{KEYSN:d.gbOvalue&&""!=d.gbOvalue?d.gbOvalue:d.keysn,SIGNSN:d.seal.signsn,DOCUMENTID:d.documentid,DOCUMENTNAME:d.documentname,APPVERSION:T.name,APPTYPE:"HTML",APPCODE:this.appcode,EXTPARAM2:b})},error:function(a,b,d,e){d=a;l.is("Object",a)&&(d=a.errcode&&"511"!=a.errcode?a.errcode:a.errmsg);d||(d="-999");b=l.is("String",b)?b:"then";v.hideLoading();c.options.errorCall?c.options.errorCall.call(null,a,b):v.alert(m.msg(d,b),function(){e&&e._beginDlgOkCall&&1==
e._beginDlgOkCall||c.options.beginDlgOkCall&&c.options.beginDlgOkCall.call()},function(){c.options.beginDlgShowCall&&c.options.beginDlgShowCall.call()})},load:function(a){this.trigger("beforeLoad");this.setAttr(a);this.certService=new c.factory.cert[c.options.certType](a,this.signatureData);var b=this.signatureData;if(void 0!==a.extra&&null!==a.extra&&void 0!==a.extra[this.signatureid]){if(void 0!==a.extra[this.signatureid].scaleImage&&null!==a.extra[this.signatureid].scaleImage&&(b.seal.height*=
a.extra[this.signatureid].scaleImage,b.seal.width*=a.extra[this.signatureid].scaleImage),void 0!=a.extra[this.signatureid].position){var d=h.extend({},b.position),e="",g;for(g in d)e=g;this.removeItem(b.position);this.updatePos(a.extra[this.signatureid].position,{marginLeft:null==a.extra[this.signatureid].offsetX?d[e].marginLeft:a.extra[this.signatureid].offsetX,marginTop:null==a.extra[this.signatureid].offsetY?d[e].marginTop:a.extra[this.signatureid].offsetY})}}else void 0!==a.scaleImage&&null!==
a.scaleImage&&(b.seal.height*=a.scaleImage,b.seal.width*=a.scaleImage);this.sealService=new c.factory.seal[c.options.sealType](a,b);this._init();this.trigger("load");return this},toBase64Img:function(a){var b=a.imgdata,d=b.indexOf(a.signsn);if(-1==d)return b;b=a.imgdata.substring(d+65);return l.Base64.of().encodeByte(l.Base64.of(a.signsn).decodeByte(b))},clearImg:function(){if(this.imgEles)for(var a in this.imgEles)this.trigger("removeAt",this.imgEles[a][0]),this.imgEles[a].remove();this.imgEles=
{}},repaint:function(){this.clearImg();this.verify()},getUpdateType:function(){return this._item},updatePos:function(a,b){var d=this.signatureData.position[a];this._item="position";this.signatureData.position[a]=l.extend({},d,b)},updateItem:function(a,b){this._item=a;this.signatureData[a]=b},removeItem:function(a){for(var b in a)delete a[b]},fireUpdate:function(a){var b=this,d=function(d){a&&a(d);b[d?"update":"restore"]();delete b._item};c.asyn.update?c.asyn.update.call(b,d):(this.trigger("fireupdate"),
d(!0));return this},restore:function(){this.setSignatureData(this.oriSignatureData);this.repaint()},update:function(){this.setSignatureData(this.signatureData);this.repaint();this.trigger("update");return this},remove:function(){this.clearImg();this.trigger("remove");for(var a in this)delete this[a];return this},fireRemove:function(a){var b=this,d=function(d){a&&a(d);d&&b.remove()};c.asyn.remove?c.asyn.remove.call(b,d):(this.trigger("fireremove"),d(!0));return this},hide:function(){if(this.imgEles)for(var a in this.imgEles)this.imgEles[a].hide()},
createImg:function(){var a=this.signatureData,b=h(document.createElement("img")),d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII=";this.broken||(d="data:image/"+a.seal.imgext+";base64,"+this.toBase64Img(a.seal));b.css({width:Math.ceil(9600*parseFloat(a.seal.width)/254),height:Math.ceil(9600*parseFloat(a.seal.height)/254)}).attr({src:d});return b},show:function(){var a=this.signatureData.position,b=this.imgEles=this.imgEles||{},d;
for(d in a){var e="kg-img-div-"+this.signatureid+"-"+d,c=b[e];c||(c=b[e]=this.showAt(d,a[d]));this._handleImg(c)}this.trigger("show")},showAt:function(a,b){this.trigger("beforeShowAt",a,b);var d=l.$(a),e=h(d);this.extra&&this.extra[this.signatureid]&&(d=this.extra[this.signatureid].scopePosition)&&(e=d instanceof Object?d.find("#"+a):h(l.$(d)).find("#"+a));if(0==e.length)if(c.options.defaultPos)a=c.options.defaultPos,e=h(l.$(a));else throw Error("no find position:"+a+" signatureid="+this.signatureid);
var g=this.createImg();g.addClass("kg-img").attr("id","kg-img-"+this.signatureid);d=h(document.createElement("div")).addClass("kg-img-div").addClass("kg-img-div-"+a).attr({id:"kg-img-div-"+this.signatureid+"-"+a,elemid:a,signatureid:this.signatureid});d.append(g);d.css({width:g.width(),height:g.height()});var f=0,k=0,t=this.signatureData.dateTime;null!=t&&t.isCheck&&t.fontDate&&(this.addDateToImg(t.fontDate,this.signatureData.timestamp.time,d),null!=this.imageAndDate&&this.imageAndDate&&"outside"==
t.fontDate.fontPosition[2]&&("right"==t.fontDate.fontPosition[3]?f+=d.width():"left"==t.fontDate.fontPosition[3]&&(f+=d.width()),"below"==t.fontDate.fontPosition[4]&&(k+=d.height())));d.css({width:g.width()+f,height:g.height()+k});g=d;f="kg-default";if(t=e.attr("display"))e.addClass("display-"+t),f="kg-"+t,k=e,g=document.getElementById("kg-img-container-"+a),g||(g=document.createElement("div"),g.setAttribute("id","kg-img-container-"+a)),g=h(g).addClass(f+"-container"),g.append(d),d.attr("kg-display",
!0);else if(k=e.offsetParent(),"html"==k[0].tagName.toLowerCase()||"relative"==k[0].style.position)k=h("body");d.addClass(f);k.append(g);if(t){if("landscape"===t){e=g.children();f=g.parent().width();var m=0;e.each(function(){m+=parseInt(h(this).width())+1});g.width(m>f?m:f)}}else this.calSealPos(e,d,g,b);this.trigger("showAt",d[0],a,b);return d},calSealPos:function(a,b,d,e){var c=a.offsetParent();d=d||b;if("html"==c[0].tagName.toLowerCase()||"relative"==c[0].style.position)c=h("body");a=a.offset();
var f=c.offset();c.is("body")&&(f={top:0,left:0});d.css({top:a.top-f.top,left:a.left-f.left});e?(c=e.marginLeft,e=e.marginTop):(c=b.css("marginLeft"),e=b.css("marginTop"));b.css({marginLeft:c||0,marginTop:e||0})},addDateToImg:function(a,b,d){b=m.Utils.formatDate(new Date(b),a.fontFormat);var e=h(document.createElement("div")).addClass("kg-date"),c=0,f=0;"outside"==a.fontPosition[2]&&("right"==a.fontPosition[3]?c+=d.width():"left"==a.fontPosition[3]&&(c-=d.width()),"below"==a.fontPosition[4]&&(f+=
d.height()));e.css({width:d.width(),height:d.height(),top:f,left:c});c=h(document.createElement("div")).addClass("kg-date-tmb").css({width:d.width()});f=h(document.createElement("div")).addClass("kg-date-lcr").css({"text-align":a.fontPosition[0],"font-family":a.fontFamily,"font-size":a.fontSize+"px",color:a.fontColor});"bottom"==a.fontPosition[1]?c.css({bottom:0}):"middle"==a.fontPosition[1]&&f.css({"line-height":d.height()+"px"});f.html(b);c.html(f);e.html(c);d.append(e)},canSign:function(){return!this.modified&&
!c.options.readonly&&c.options.signable&&!this.signatureData.signMeta},canMove:function(a){(a=!c.options.readonly&&this.signatureData.moveable&&c.options.moveable&&!h(a).attr("kg-display"))&&c.options.moveable_self&&(a=this.signatureData.keysn==c.options.keysn);return a},canDelete:function(){return!c.options.readonly},_handleImg:function(a){a.show();if(0==a.children(".kg-shade").length){var b=h(document.createElement("div")).addClass("kg-shade");b.append(S("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII=",
a.width(),a.height()));a.append(b)}this._invalid(a);this.trigger("handleImg",a[0])},setSignatureData:function(a){l.is("String",a)?this.signatureData=JSON.parse(l.Base64.of().decode(a)):this.signatureData=a;this.oriSignatureData=JSON.parse(JSON.stringify(this.signatureData))},getSignatureid:function(){return this.signatureid},getSignatureData:function(){var a=JSON.stringify(this.signatureData);return l.Base64.of().encode(a)},getBase64Image:function(a,b,d,c){d="kg-img-div-"+a+"-"+d;d=document.getElementById(d);
null!=d&&(A?c(this,"",a,b):html2canvas(d).then(function(d){d=d.toDataURL("image/png").split(",");c(this,d,a,b)}))},_invalid:function(a){var b=a.children(".kg-invalid");if(0==b.length){b=h(document.createElement("div")).addClass("kg-hide").addClass("kg-invalid");a.append(b);var d=a.height()/3;b.css({top:d,height:d});d/=3;for(var c=a.width(),g=0;3>g;g++){var f=h(document.createElement("div")).height(d);0==g%2&&(f.addClass("kg-invalid-item"),f.append(S("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mNoaGgAAAMEAYF1LgG8AAAAAElFTkSuQmCC",
c,d)));b.append(f)}}if(this.modified){d="";for(c=0;c<this.modifiedItems.length;c++)g=this.modifiedItems[c],d+=g.desc+"["+g.field+"]\u7531{"+g.orivalue+"}\u66f4\u6539\u4e3a{"+g.newvalue+"};";a.attr("modified",d).addClass("error");b.removeClass("kg-hide")}else a.removeAttr("modified").removeClass("error"),b.addClass("kg-hide")},_verify:function(a,b){this.trigger("before_verify");a=this.verifyProtectedData(a);if(!b||b&&b.batchVerify||null==this.oriSignatureData.timestamp.timestampInfo)return this.show(),
this.trigger("_verify"),!a;var d=this;this.getVerifyTimeStamp(this.oriSignatureData.timestamp.timestampInfo,function(a){d.timeVerify=a;d.show();d.trigger("_verify");b&&b.sucCall&&b.sucCall.call(d)})},verify:function(a,b){this.trigger("beforeVerify");a=this._verify(a,b);this.trigger("verify");return a},getVerifyProtectedItems:function(a,b){for(var d in a)if(void 0!=a[d]&&null!=a[d]){var c=a[d];if(c.field==b)return c}return null},getVerifyProtectedData:function(){for(var a=this.validatedData,b=this.signatureData.protectedData,
d={},c=0;c<b.length;c++)if(void 0!=b[c]&&null!=b[c]){var g=b[c],f=g.field,k=a&&(a[f]||this.getVerifyProtectedItems(a,f)&&this.getVerifyProtectedItems(a,f).value);if(null==k){var t=l.$(f);if(t){if(k=t.getAttribute("kg-value")||t.value,void 0===k||null===k)k=t.innerHTML||t.innerText}else k=void 0!=g.name&&null!=g.name?document.getElementById(g.name).value:""}g=l.val(k,this);g=this._formatValue(g);d[f]=g}return d},getSignTimeStamp:function(a){for(var b={},d=0;d<a.length;d++)b[a[d].field]=a[d].value;
return l.Base64.of().encode(q(b))},getValidatedTimeStamp:function(){var a=this.getVerifyProtectedData();a=q(a);return l.Base64.of().encode(a)},getVerifyTimeStamp:function(a,b){var d=this.getValidatedTimeStamp(),e=a.CertData,g=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);g.invoke("SetParamByName","TSCERTDATA",l.Base64.of().encode(e)).ret(function(){g.invoke("KGVerifyTSWithReq",a.TimeStampResponse,a.TimeStampResult,"",d,a.TimeStr,
"").ret(function(a){b.call(this,a.result)})})},getH5SignData:function(){var a=this.hashAlg,b=this.encryptAlg,d=CryptoJS.SHA1(this.getSignData()).toString();return[{hashAlg:a,encryptAlg:b,signdata:d}]},verifyProtectedData:function(a){a&&(this.validatedData=a);a={};h.extend(!0,a,this.signatureData.protectedData);c.verifyData&&(this.validatedData=c.verifyData(a));a=[];for(var b=this.getVerifyProtectedData(),d=this.signatureData.protectedData,e=0;e<d.length;e++)if(void 0!=d[e]&&null!=d[e]){var g=d[e],
f=b[d[e].field];f!==g.value&&a.push({field:g.field,desc:g.desc,orivalue:g.value,newvalue:f})}this.modified=0<a.length;this.modifiedItems=a;return this.modified},verifySignData:function(a){var b=this;v.showLoading();var d=this.certService;if(this.signatureData.signMeta.html2sign){d instanceof M||(d=new M(c.options),d.sData=b.signatureData);var e=b.getVerifyProtectedData();for(var g=this.signatureData.protectedData,f=[],k=0;k<g.length;k++){var t=g[k],m={},l;for(l in t)t.hasOwnProperty(l)&&(m[l]=t[l]);
m.value=e[t.field];f.push(m)}e=q(f)}else e=this.getValidatedSignData();d.verifySign(h.extend({seal:this.signatureData.seal,signeddata:this.signatureData.signMeta.signeddata,crtdata:this.signatureData.signMeta.certinfo.crtdata,keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,signdata:e},{successCall:function(d){v.hideLoading();if(!d.errcode){b.signModified=!d.result;var c=b.verify(null,{sucCall:function(){a&&a(d)}})}null!=c&&a&&a(d)}}))},_renderValue:function(a){return a.replace(/\r\n/ig,
"<br>")},_formatValue:function(a,b){a&&(a=a.replace(/\r\n/ig,"\n"),a=a.replace(/\n/ig,"\r\n"));return a},getItemVal:function(a){var b;if(b=l.is("String",a)?l.$(a):a)return a=b.tagName.toLowerCase(),"input"===a||"textarea"===a||"select"===a?b.getAttribute("kg-value")||b.value:b.getAttribute("kg-value")||(A?b.innerText:b.textContent);throw Error("No find protectedItem:"+a+" signatureid="+this.signatureid);},getProtectedData:function(a){var b=this,d=[],c=function(a){var d=l.$(a);if(d){var c={field:a};
c.desc=d.getAttribute("kg-desc")||a;c.value=b.getItemVal(d);return c}throw Error("No find protectedItem:"+a+" signatureid="+this.signatureid);},g=function(a){if(l.is("String",a))a=c(a);else if(!l.is("Object",a)||!a.field)throw Error("Unsupported protectedItems:"+a.toString);l.is("Function",a.value)&&(a.value=a.value.call(b,a.field,a.desc));a.value=b._formatValue(a.value);return a};if(a)if(l.is("Array",a))for(var f=0,k=a.length;f<k;f++)d.push(g(a[f]));else d.push(g(a));return d},__findSignedData:function(a){if(l.is("String",
a))return a.split(";")[0];if(l.is("Array",a))return a[0];throw Error("error signeddata: "+a);},getValidatedSignData:function(){var a=this.getVerifyProtectedData();a=q(a);a=l.Base64.of().encode(a);return CryptoJS.SHA1(a).toString()},getSignData:function(a){a=(a||this.signatureData).protectedData;for(var b={},d=0;d<a.length;d++)b[a[d].field]=a[d].value;return l.Base64.of().encode(q(b))},showSignSignatureDialog:function(a){var b={target:l.is("Array",a.target)?a.target:[a.target],title:m.msg("SignSignature",
"KG_TITLE"),onCancel:function(){c.options.dlgCancelCall&&c.options.dlgCancelCall.call()},onShow:function(){var a=this;setTimeout(function(){a.find("#kg-password").focus()},40);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},onOk:function(){var b=this.find("#kg-password");if(!b.val())return v.alert(m.msg("in_pwd_msg","KG_MSG"),function(){b.focus()}),!1;a._onOk.call(this,b.val());return!1}};return this.showDialog("signSignatureBtl",b)},changeMoveAble:function(a,b){this.signatureData.moveable=
a;this.fireUpdate();b&&b()},signSignature:function(a){var b=this,d={target:b,_onOk:function(d){var c=this,e=b.getH5SignData();b.runSign(e,d,function(d){d.result?b.fireUpdate(function(a){a&&c.remove()}):b.error(d,null,null,{_beginDlgOkCall:!0});a&&a(d)})}};if(b.signatureData.phoneshield)"client"==c.options.sealType&&b.sealService.getPhoneShieldLic({phoneshield:c.options.phoneshield},function(a){"1"==a.phoneshield||"3"==a.phoneshield?(m.options.timeout=1E3*(a.validatetime+10),d._onOk("")):"2"==a.phoneshield?
b.error({errcode:"11110"},"then"):b.error({errcode:"11109"},"then")});else return b.showSignSignatureDialog(d)},showRevokeSignatureDialog:function(a){var b={target:l.is("Array",a.target)?a.target:[a.target],title:m.msg("RevokeSignature","KG_TITLE"),quickClose:void 0==c.options.quickClose?!0:c.options.quickClose,onCancel:function(){c.options.dlgCancelCall&&c.options.dlgCancelCall.call()},onShow:function(){c.options.beginDlgShowCall&&c.options.beginDlgShowCall.call();var a=this;setTimeout(function(){a.find("#kg-password").focus()},
40);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},onOk:function(){var b=this.find("#kg-password");if(!b.val())return v.alert(m.msg("in_pwd_msg","KG_MSG"),function(){b.focus()}),!1;a._onOk.call(this,b.val());return!1}};return this.showDialog("revokeSignatureBtl",b)},revokeSignature:function(a){var b=this,d={target:b,_onOk:function(d,g){var e=this;v.showLoading();b.sealService.verifyPwd({pwd:d,keysn:b.signatureData.keysn,successCall:function(d){v.hideLoading();
d.result&&(void 0!=d.delkeysn?d.delkeysn==b.signatureData.keysn:1)?void 0!==c.options.delCallBack&&c.options.delCallBack?c.options.delCallBack(b.signatureid,b.signatureData)&&b.fireRemove(function(a){a&&(e.remove?e.remove():b.remove())}):b.fireRemove(function(a){a&&(e.remove?e.remove():b.remove())}):b.error(d,null,null,{_beginDlgOkCall:!0});a&&a(d)},phoneshield:g})}};if(b.signatureData.phoneshield&&"client"==c.options.sealType)b.sealService.getPhoneShieldLic({phoneshield:"1"},function(a){"1"==a.phoneshield||
"3"==a.phoneshield?(m.options.timeout=1E3*(a.validatetime+10),d._onOk("","1")):"2"==a.phoneshield?b.error({errcode:"11110"},"then"):b.error({errcode:"11109"},"then")});else if(c.options.showNoPW&&"server"==c.options.sealType)d._onOk(c.options.password);else return b.showRevokeSignatureDialog(d)},showDialog:function(a,b){var d=l.is("Array",b.target)?b.target:[b.target],e={title:m.msg("KinggridSignature","KG_TITLE"),onShow:function(){var a=this;setTimeout(function(){a.find("#kg-password").focus()},
40);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},onCancel:b.errCall||function(){v.hideLoading();return!0},content:function(){var b=[c.options.template[a]].concat(d);return l.template.apply(null,b)}};b=l.extend(e,b);var g=v.showDialog(a,b);if("showSealsBtl"===a){var f=g.find("#sealTpl-dialog"),k=!1,h=0,n=0,p=0,C=0;f.prevObject[0].onmousedown=function(a){k=!0;a=a||event;null!=a&&(h=a.clientX,n=a.clientY,p=parseInt(f.prevObject[0].style.top),C=parseInt(f.prevObject[0].style.left))};
f.prevObject[0].onmousemove=function(a){if(k&&(a=a||event,null!=a)){var b=C+a.clientX-h;a=p+a.clientY-n;0<b&&0<a&&(f.prevObject[0].style.left=b+"px",f.prevObject[0].style.top=a+"px")}};f.prevObject[0].onmouseup=function(a){k&&(k=!1,C=p=n=h=0)}}"signatureInfoBtl"!=a&&"signInfoBtl"!=a||g.find(".ui-dialog-close").click(function(){g.close();c.options.dlgCancelCall&&c.options.dlgCancelCall.call()});return g},runMove:function(a,b,d){var e=this;z.trigger("startMove",e,a,b);var g=function(a){var b=a.moveableRange;
if(!b){for(c in a.position){var d=c;break}(a=h("#"+d).attr("kg-mita"))&&(b=a)}if(b){var c=h("#"+b);if(0<c.length)return b=c.offset().left,a=c.offset().left+c.outerWidth(),d=c.offset().top,c=c.offset().top+c.outerHeight(),{left:b,right:a,top:d,bottom:c}}return{left:0,right:0,top:0,bottom:0}};return"client"==c.options.sealType&&c.options.moveable_self&&e.keysn!=e.signatureData.keysn?(c.alert(m.msg("cannot_move","KG_MSG")),!1):function(a,b,d){var c=g(e.signatureData);b=N.create(b,a,!0,c);b.onend=function(a,
b,c,f){d&&d(b,c,f);z.trigger("endMove",e,a,c,f);b&&(a=h(this),e.updatePos(a.attr("elemid"),{marginLeft:c,marginTop:f}),e.fireUpdate())};a.preventDefault();return b}(a,b,d)},runSign:function(a,b,d){var e=this,g=e.signatureData;v.showLoading();e.certService.sign({seal:this.signatureData.seal,keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,password:b,phoneshield:this.signatureData.phoneshield,signMeta:a,successCall:function(b){v.hideLoading();b.result&&(b.signeddata?(b.certinfo.algName=
b.certinfo.algName.toUpperCase(),e.updateItem("signMeta",{hashAlg:a[0].hashAlg,encryptAlg:a[0].encryptAlg,signdata:a[0].signdata,signeddata:e.__findSignedData(b.signeddata),certinfo:b.certinfo})):(b.result=!1,b.errcode="signErr"),g.certType=c.options.certType);d&&d(b)}})}});var v=w();c.options=h.extend({savelogFlg:!0,b64Url:"/iWebSignature_base64",imageUrl:"/iWebSignature_image"},m.options,{dialogConfig:{okValue:"\u786e  \u5b9a",cancelValue:"\u53d6  \u6d88",fixed:!0,backdropOpacity:.2,modal:!0},template:{}},
window.KGCONFIG);c.addProvider=function(a,b,d){c.factory[a][b]=d};var G;c.init=function(a,b){this.Seals={};l.extend(c.options,a);var d=c.options;b=b?b:a.okCall;d.serverUrl&&(d.b64Url="_signature_b64",d.imageUrl="_signature_image",0<d.serverUrl.indexOf("?")?d.serverUrl+="&action=rest":d.serverUrl+="?action=rest");"client"==d.sealType?(d.clientUrl=d.https,G=c.aisleKing=m.surry(d.clientUrl?d.clientUrl:"http://127.0.0.1:9581","IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode)):
G=c.aisleKing=m.surry(d.serverUrl||d.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);(a=d.clientConfig)&&"client"===d.sealType?c.AXI("SetParamByName",a,b):b&&b.call();z.trigger("init")};c.factory={cert:{},seal:{}};c.SealService=D;c.CertService=L;c.asyn={};c._create=function(a){var b=this;b.setAttr(a);b.certService=new c.factory.cert[b.certType](a);b.sealService=new c.factory.seal[b.sealType](a);b.on("createSignature",function(a,c,g){a=[];var d=b._getLogInfo({LOGTYPE:"00",
LOGSORT:"13",LOGMEMO:"\u76d6\u7ae0\u6210\u529f",LOGSORTSUBCLASS:"1301"});a.push(l.extend(c||{},d));g&&a.push(b._getLogInfo({LOGTYPE:"00",LOGSORT:"304",LOGMEMO:"\u6570\u5b57\u7b7e\u540d\u6210\u529f"}));b.sealService.saveLog(a)});return this};w=function(){};w.prototype=c.prototype;w=new w;c._create.prototype=w;h.extend(w,{keyData:null,sealExpired:function(a,b,d,e,g){var f=this,k=!0;if(void 0===c.options.valid||null===c.options.valid||!1===c.options.valid)return f.certExpired(b,d,e);if(void 0!==a.endata&&
null!==a.endata){var m=a.endata;g=parseInt(d.substr(0,4));a=parseInt(d.substr(5,2));k=parseInt(d.substr(8,2));var l=parseInt(m.substr(0,4)),n=parseInt(m.substr(5,2));m=parseInt(m.substr(8,2));g>l?(f.errorCallback({errcode:"11104"},b.errorCall),k=!1):g==l?a>n?(f.errorCallback({errcode:"11104"},b.errorCall),k=!1):a==n?k>m?(f.errorCallback({errcode:"11104"},b.errorCall),k=!1):k=!0:k=!0:k=!0}else return a=c.options.serverUrl+"_key_sealIsExpired",g=(parseInt(g)+1).toString(),h.ajax({url:a,type:"POST",
data:{keysn:f.keyData.keysn,year:(new Date).getFullYear(),month:(new Date).getMonth(),date:(new Date).getDate(),index:g},async:!1,success:function(a){if(a.error)return f.errorCallback({errcode:"11105"},b.errorCall),!1;if(0==a.result)return f.certExpired(b,d,e);f.errorCallback({errcode:"11104"},b.errorCall);return!1},error:function(a){f.errorCallback({errcode:"11105"},b.errorCall)}}),!1;return k?f.certExpired(b,d,e):k},certExpired:function(a,b,d){var e=this,g=!1;if(void 0===c.options.valid||null===
c.options.valid||!1===c.options.valid)return!0;m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode).invoke("KGGetCerInfo","").ret(function(c){var f=parseInt(b.substr(0,4)),h=parseInt(b.substr(5,2)),m=parseInt(b.substr(8,2));if(c.result){c=c.certinfo.notAfter;var l=parseInt(c.substr(0,4)),C=parseInt(c.substr(4,1));C=0==C?parseInt(c.substr(5,1)):parseInt(c.substr(4,2));var n=parseInt(c.substr(6,1));n=0==n?parseInt(c.substr(7,1)):parseInt(c.substr(6,
2));f>l?e.errorCallback({errcode:"11103"},a.errorCall):f==l?h>C?e.errorCallback({errcode:"11103"},a.errorCall):h==C?m>n?e.errorCallback({errcode:"11103"},a.errorCall):g=!0:g=!0:g=!0}else e.errorCallback({errcode:"11106"},a.errorCall);void 0!==d&&null!==d&&d(g)});return g},errorCallback:function(a,b,d,c){b?(v.hideLoading(),b.call(null,a,d)):this.error(a,d,null,c)},runHW:function(a,b){var d=this;v.showLoading();"undefined"!=typeof a.imageData&&null!=a.imageData&&(void 0!==a.beginCall&&a.beginCall&&
a.beginCall.call(d),d.sealService.loadSeal({data:a.imageData,successCall:function(c){v.hideLoading();if(c.result&&c.seals){for(var e in c.seals){c.seals=[{width:a.width,height:a.height,imgext:c.seals[e].imgext,signname:a.name,signsn:c.seals[e].signsn,username:c.seals[e].username,imgdata:a.imageData,headinfoex:c.seals[e].headinfoex}];break}d.keyData=c;d.showSeals(b)}else d.errorCallback(c,a.errorCall)},errorCall:function(b){d.errorCallback(b,a.errorCall)}}))},run:function(a){var b=this;b.keyData?b.showSeals(a):
(v.showLoading(),void 0!==a.beginCall&&a.beginCall&&a.beginCall.call(b),b.sealService.loadSeal({successCall:function(d){v.hideLoading();d.result?d.seals&&d.seals.length?(b.keyData=d,void 0!==c.options.imgtag&&0!==c.options.imgtag&&void 0===d.ServerTime?void 0!==b.serverUrl&&null!==b.serverUrl?(d={usercode:b.usercode,keysn:b.keyData.keysn,signname:b.signname,authcode:c.authcode},m.surry(b.serverUrl).request("_key_load",d).ret(function(d){d.result?(b.curDate=d.ServerTime,b.keyData=d,b.showSeals(a)):
b.errorCallback(d,a.errorCall)})):(b.curDate=(new Date).toLocaleString(),b.showSeals(a)):(b.curDate=d.ServerTime,b.showSeals(a))):b.errorCallback({errcode:"11100"+c.options.imgtag},a.errorCall):b.errorCallback(d,a.errorCall)},errorCall:function(d){b.errorCallback(d,a.errorCall)}}));return this},getSealsByKeysn:function(a,b,d){var c=this;c.sealService.loadSeal({successCall:function(a){if(a.result){var d=[];if(void 0!==b&&null!=b){for(var e=0;e<a.seals.length;++e)d[e]=c.toBase64Img(a.seals[e]);b(d)}}},
errorCall:function(a){c.errorCallback(a,d.errorCall)}})},loadSeals:function(a,b){var d=this;d.sealService.loadSeal({successCall:function(b){void 0!==a&&null!==a&&null!==b&&void 0!==b.seals&&null!==b.seals&&a(b)},errorCall:function(a){d.errorCallback(a,b&&b.errorCall?b.errorCall:null)}})},runSS:function(a,b){var d=this;null!==b&&(d.keyData=b,null==b.seals||0==b.seals.length?d.errorCallback({errcode:"11107"},a.errorCall):void 0!==c.options.imgtag&&0!==c.options.imgtag&&void 0===b.ServerTime?void 0!==
d.serverUrl&&null!==d.serverUrl?(b={usercode:d.usercode,keysn:d.keyData.keysn,signname:d.signname,authcode:c.authcode},m.surry(d.serverUrl).request("_key_load",b).ret(function(b){b.result?(d.curDate=b.ServerTime,d.keyData=b,d.showSeals(a)):d.errorCallback(b,a.errorCall)})):(d.curDate=(new Date).toLocaleString(),d.showSeals(a)):(d.curDate=b.ServerTime,d.showSeals(a)))},formatPos:function(a,b,d){var c={};if(a){var g=function(a){var e=a.elemid||a[0].id;e||(e="body");c[e]=void 0!=b&&void 0!=d?{marginLeft:b,
marginTop:d}:l.filter(a,e)};if(l.is("Array",a))for(var f=0;f<a.length;f++)g(a[f]);else l.is("String",a)?c[a]=void 0!=b&&void 0!=d?{marginLeft:b,marginTop:d}:{}:g(a)}else c.body={};return c},exec:function(a,b,d,e,g,f){var k=this;delete k.signatureData;var h=null!=a.protectedItemsType&&"1"==a.protectedItemsType?a.protectedItems:k.getProtectedData(a.protectedItems);h={timestamp:{time:void 0==a.signtime?(new Date).getTime():(new Date(Date.parse(a.signtime.replace(/-/g,"/")))).getTime(),signtime:void 0==
a.showtime?a.signtime:a.showtime,timestampInfo:a.timestampInfo},appname:navigator.userAgent,documentid:void 0==a.documentid?k.documentid:a.documentid,documentname:void 0==a.documentname?k.documentname:a.documentname,moveable:l.boolean(a,"moveable",c.options.moveable),keysn:k.keyData.keysn,orgname:k.keyData.orgname,usercode:k.keyData.usercode,username:k.keyData.username||d.username,phoneshield:c.options.phoneshield?!0:!1,gbOvalue:k.keyData.gbOvalue,seal:d,moveableRange:a.moveableRange,protectedData:h,
sealType:a.sealType||k.sealType,extparam:a.extparam,ver:c.version,dateTime:a.datetime};k.signatureData=h;k.certService.sData=k.signatureData;k.sealService.sData=k.signatureData;v.showLoading();var m=a.autoCert||k.autoCert||c.options.phoneshield&&"1"!=c.options.fjrsIsphone,n=function(a){var b=k.signatureData;if(a&&a.position){if(a.offsetX&&a.offsetY)a.changeOffsetXY&&a.changeOffsetXY(a),b.position=k.formatPos(a.position,a.offsetX,a.offsetY);else if(a.changeOffsetXY){var e={width:Math.ceil(9600*parseFloat(d.width)/
254),height:Math.ceil(9600*parseFloat(d.height)/254)};e=a.changeOffsetXY(e);b.position=k.formatPos(a.position,e.offsetX,e.offsetY)}else b.position=k.formatPos(a.position);e=a.signatureid||k.genId();a&&a.scopePosition&&(void 0==c.options.extra&&(c.options.extra={}),c.options.extra[e]={scopePosition:a.scopePosition});b.timeid=(new Date).getTime();var f=(new c(e,b)).load(c.options);a.okCall&&(b={name:d.signname,height:d.height,width:d.width,imgdata:k.toBase64Img(d)},a.isBatchSignature?a.okCall.call(f,
function(a){},a.documentid):a.okCall.call(f,function(b){k.trigger("createSignature",f,a.logMeta,m);b&&f.show()},b));v.hideLoading()}else throw Error("no set position");};if(m){k.getSignData(h);h=k.getH5SignData();if(a.signMeta)h[l.is("Array",a.signMeta)?"concat":"push"](a.signMeta);a.beforeSignCall&&a.beforeSignCall.call(k,h);g?"client"==c.options.sealType?k.runSign(h,e,function(c){c.result&&(n(a),f&&1<f.batchSignature.length&&(a.documentid=f.batchSignature[f.batchSignature.length-1].documentid,a.documentname=
f.batchSignature[f.batchSignature.length-1].documentname,a.position=f.batchSignature[f.batchSignature.length-1].position,a.protectedItems=f.batchSignature[f.batchSignature.length-1].protectedItems,--f.batchSignature.length,k.exec(a,b,d,e,g,f)));b(c)}):k.runSign(h,e,function(d){d.result&&n(a);b(d)}):k.runSign(h,e,function(d){d.result&&n(a);b(d)})}else g?n(a):k.sealService.verifyPwd({pwd:e,keysn:h.keysn,successCall:function(d){d.result?n(a):c.options.pwd_clear_flag&&k.onDeleteRPW?k.onDeleteRPW():null;
b(d)},phoneshield:c.options.phoneshield})},runPwd:function(a){var b=this;b.showPwdDialog({cancelCall:a.cancelCall,_onOk:function(d){c.options.showNoPW=!0;c.options.password=d;var e=this.find("#kg-remenberPwd").is(":checked");b.trigger("execSuccess",this,d,e);b.run(h.extend(a,{beginCancalCall:function(){c.options.showNoPW=!1;c.options.password=""}}))}})},showPwdDialog:function(a){var b=this,d=a._onOk;b.showDialog("passwordTpl",{onCancel:a.cancelCall,onShow:function(){var a=this;b.trigger("showSealsDialog_PW",
a);setTimeout(function(){a.find("#kg-password").focus()},40);a.find("#kg-password").keydown(function(b){13==b.keyCode&&a.options.onOk.call(a)})},onOk:function(){var a=this.find("#kg-password"),b=a.val();b?(d.call(this,b),this.remove()):v.alert(m.msg("in_pwd_msg","KG_MSG"),function(){a.focus()});return!1},content:function(){return l.template.apply(null,[v.template.passwordTpl])}})},getPassCheck:function(a,b,d){if(a&&1==a)return a;if(void 0===d||!0===d||"auto"===d)try{return b.find("#kg-remenberPwd").is(":checked")}catch(e){}return!1},
showSeals:function(a){var b=this,d={errorCall:a.errorCall,cancelCall:a.cancelCall,beginCancalCall:a.beginCancalCall,protectedItems:a.protectedItems,protectedItemsType:a.protectedItemsType,protectedItemsCheckedAll:void 0==a.protectedItemsCheckedAll?!0:a.protectedItemsCheckedAll,_onOk:function(d,e,f,g,h,l){var k=this,n=new v.kgFont(null==k.fontSel?null==b.signdate?{}:b.signdate:k.fontSel),t=k.isCheck;!1!==c.options.showSealsDlg&&b.autoDlg||!c.options.signdate||!c.options.signdate.ischeck||(t=c.options.signdate.ischeck);
a.protectedItems=null==k.proItems?0==a.protectedItemsCheckedAll?[]:a.protectedItems:k.proItems;a.datetime={isCheck:t,fontDate:n};void 0!=g&&null!=g?(a.signtime=g,void 0!=h&&null!=h?(a.showtime=(g+" ("+h.TimeExt+")").replace(/-/g,"/"),a.showtime+=m.msg("timestamp_time","KG_MSG"),a.timestampInfo=h):(a.showtime=(new Date(Date.parse(g.replace(/-/g,"/")))).toLocaleString(),a.showtime+=m.msg("server_time","KG_MSG"))):(a.signtime=void 0,a.showtime=(new Date).toLocaleString(),a.showtime+=m.msg("local_time",
"KG_MSG"));l=b.getPassCheck(l,k,c.options.showSealsDlg);void 0===c.options.valid||null===c.options.valid||!1===c.options.valid?a.batchSignature?b.sealService.verifyPwd({pwd:e,usercode:void 0==a.usercode?"":a.usercode,keysn:b.keyData.keysn,successCall:function(f){if(f.result){for(f=0;f<a.batchSignature.length&&(a.batchSignature[f].signtime=a.signtime,a.batchSignature[f].showtime=a.showtime,null!=a.position&&(a.batchSignature[f].position=a.position),a.batchSignature[f].autoCert=a.autoCert,a.batchSignature[f].okCall=
a.okCall,a.batchSignature[f].cancelCall=a.cancelCall,a.batchSignature[f].beginCall=a.beginCall,a.batchSignature[f].endCall=a.endCall,null!=a.protectedItems&&(a.batchSignature[f].protectedItems=a.protectedItems),a.batchSignature[f].protectedItemsType=a.protectedItemsType,a.batchSignature[f].datetime=a.datetime,a.batchSignature[f].offsetX=a.offsetX,a.batchSignature[f].offsetY=a.offsetY,a.batchSignature[f].changeOffsetXY=a.changeOffsetXY,a.batchSignature[f].isBatchSignature=!0,b.exec(a.batchSignature[f],
function(d){d.result?void 0!==c.options.showNoPW||!0===c.options.showNoPW?void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===c.options.showSealsDlg||!0===c.options.showSealsDlg||b.autoDlg)&&b.trigger("execSuccess",k,e,l):b.errorCallback(d,a.errorCall)},d,e,!0,a),void 0!==a.batchSignature[f].endCall&&a.batchSignature[f].endCall&&a.batchSignature[f].endCall.call(b),"client"!=c.options.sealType||!a.autoCert);++f);void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b);
(void 0===c.options.showSealsDlg||!0===c.options.showSealsDlg||b.autoDlg)&&k.remove()}else c.options.pwd_clear_flag&&b.onDeleteRPW?b.onDeleteRPW():null,b.errorCallback(f,a.errorCall)},phoneshield:c.options.phoneshield}):(b.exec(a,function(d){d.result?(void 0!==c.options.showNoPW||!0===c.options.showNoPW||c.options.phoneshield?void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===c.options.showSealsDlg||!0===c.options.showSealsDlg||b.autoDlg)&&b.trigger("execSuccess",k,
e,l),k.remove()):b.errorCallback(d,a.errorCall,null,{_beginDlgOkCall:!0})},d,e),void 0!==a.endCall&&a.endCall&&a.endCall.call(b)):void 0!==b.curDate&&null!==b.curDate&&b.sealExpired(d,a,b.curDate,function(f){f?a.batchSignature?b.sealService.verifyPwd({pwd:e,keysn:b.keyData.keysn,successCall:function(f){if(f.result){for(f=0;f<a.batchSignature.length&&(a.batchSignature[f].signtime=a.signtime,a.batchSignature[f].showtime=a.showtime,null!=a.position&&(a.batchSignature[f].position=a.position),a.batchSignature[f].autoCert=
a.autoCert,a.batchSignature[f].okCall=a.okCall,a.batchSignature[f].cancelCall=a.cancelCall,a.batchSignature[f].beginCall=a.beginCall,a.batchSignature[f].endCall=a.endCall,null!=a.protectedItems&&(a.batchSignature[f].protectedItems=a.protectedItems),a.batchSignature[f].protectedItemsType=a.protectedItemsType,a.batchSignature[f].datetime=a.datetime,a.batchSignature[f].offsetX=a.offsetX,a.batchSignature[f].offsetY=a.offsetY,a.batchSignature[f].changeOffsetXY=a.changeOffsetXY,a.batchSignature[f].isBatchSignature=
!0,b.exec(a.batchSignature[f],function(d){d.result?void 0!==c.options.showNoPW||!0===c.options.showNoPW||c.options.phoneshield?void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===c.options.showSealsDlg||!0===c.options.showSealsDlg||b.autoDlg)&&b.trigger("execSuccess",k,e,l):b.errorCallback(d,a.errorCall)},d,e,!0),void 0!==a.batchSignature[f].endCall&&a.batchSignature[f].endCall&&a.batchSignature[f].endCall.call(b),"client"!=c.options.sealType||!a.autoCert);++f);void 0!==
a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b);(void 0===c.options.showSealsDlg||!0===c.options.showSealsDlg||b.autoDlg)&&k.remove()}else b.errorCallback(f,a.errorCall)},phoneshield:c.options.phoneshield}):(b.exec(a,function(d){d.result?(void 0!==c.options.showNoPW||!0===c.options.showNoPW||c.options.phoneshield?void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b):(void 0===c.options.showSealsDlg||!0===c.options.showSealsDlg||b.autoDlg)&&b.trigger("execSuccess",
k,e,l),k.remove()):b.errorCallback(d,a.errorCall,null,{_beginDlgOkCall:!0})},d,e),void 0!==a.endCall&&a.endCall&&a.endCall.call(b)):b.errorCallback({errcode:"11103"},a.errorCall)},f)}};if(void 0!==c.options.showSealsDlg){var e=!0;if("auto"==c.options.showSealsDlg){var g=b.keyData;g.seals&&1==g.seals.length&&(e=!1)}b.autoDlg=e;if(!1!==c.options.showSealsDlg&&e)this.showSealsDialog(d);else if(void 0===c.options.password&&void 0!==b.password&&(c.options.password=b.password),void 0===c.options.password)b.errorCallback({errcode:"11108"},
a.errorCall);else if(void 0!=c.options.timestamp&&1==c.options.timestamp)if("client"==c.options.sealType){var f=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);f.invoke("KGGetTSURLInfo").ret(function(e){e.result?f.invoke("KGGetTSWithDigest",e.TimeStampUrl,e.TimeStampUserName,e.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(e){e.result?d._onOk.call(b,b.keyData.seals[0],c.options.password,
0,e.TimeStr,e):(b.errorCallback(e,a.errorCall,"KGGetTSWithDigest"),d._onOk.call(b,g.seals[0],pwdVal,0))}):(b.errorCallback(e,a.errorCall,"KGGetTSURLInfo"),d._onOk.call(b,g.seals[0],pwdVal,0))})}else h.ajax({url:c.options.serverUrl+"_key_getTimeStamp",type:"POST",data:{keysn:b.keyData.keysn},async:!1,success:function(a){a.result?d._onOk.call(b,b.keyData.seals[0],c.options.password,0,a.timestamp):d._onOk.call(b,b.keyData.seals[0],c.options.password,0)},error:function(a){d._onOk.call(b,b.keyData.seals[0],
c.options.password,0)}});else d._onOk.call(b,b.keyData.seals[0],c.options.password,0)}else this.showSealsDialog(d)},showSealsDialog:function(a){var b=this,d=b.keyData;null!=b.signdate&&(d.signDateIsCheck=b.signdate.ischeck);var e=null!=a.protectedItemsType&&"1"==a.protectedItemsType?a.protectedItems:b.getProtectedData(a.protectedItems);d.showProtectedBtn=e&&0<e.length&&c.options.showProtectedBtn;for(var g=a.protectedItemsCheckedAll,f=[],k=0;e&&k<e.length;k++)f[k]=e[k],f[k].isChecked=g;d.newProItems=
f;var n=[d],p=a._onOk,q=a.beginCancalCall;e={onCancel:a.cancelCall,onShow:function(){var e=this,f=e.find(".kg-switcher");if(f.length){var k=new l.Switcher(f[0],b.switcher||{});f.find(".arrow-right").click(function(a){a.preventDefault();k.swipeNext()});f.find(".arrow-left").click(function(a){a.preventDefault();k.swipePrev()});f.find(".kg-guide span").click(function(a){a.preventDefault();k.to(+this.getAttribute("index"))});b.switcher=k}e.find("#kg-dateSet").click(function(a){b.showFontDialog(e)});setTimeout(function(){e.find("#kg-password").focus()},
40);b.trigger("showSealsDialog",e);c.options.showNoPW&&c.options.phoneshield||b.trigger("showSealsDialog_PW",e);e.find("#kg-password").keydown(function(a){13==a.keyCode&&e.options.onOk.call(e)});e.find("#kg-protectedDataSet").click(function(c){b.showProtectedDataDialog(e,a,d)})},onOk:function(){var e=this,f=e.find("#kg-password"),k=f.val()||c.options.password;if(!c.options.phoneshield&&!k)return v.alert(m.msg("in_pwd_msg","KG_MSG"),function(){setTimeout(function(){f.focus()},100)}),!1;var g=e.find(".kg-wrapper .active");
e.isCheck=e.find("#kg-addDate").is(":checked");var l=e.find("#kg-remenberPwd").is(":checked"),n=b.keyData.seals[g.attr("index")].SealTag||b.keyData.seals[g.attr("index")].sealtag;if("client"==c.options.sealType&&n&&"GM"==n){var t=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);n=b.keyData.seals[g.attr("index")].SealCert||b.keyData.seals[g.attr("index")].signercert;var q=b.keyData.seals[g.attr("index")].ValidStart||b.keyData.seals[g.attr("index")].validstart,
r=b.keyData.seals[g.attr("index")].ValidEnd||b.keyData.seals[g.attr("index")].validend,u=b.keyData.seals[g.attr("index")].CertList||b.keyData.seals[g.attr("index")].certlist;t.invoke("KGValidate_GM","",n,q,r,u,"").ret(function(f){if(f.result)if(void 0!=c.options.timestamp&&1==c.options.timestamp){var h=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);h.invoke("KGGetTSURLInfo").ret(function(c){c.result?h.invoke("KGGetTSWithDigest",
c.TimeStampUrl,c.TimeStampUserName,c.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(c){c.result?p.call(e,d.seals[g.attr("index")],k,g.attr("index"),c.TimeStr,c,l?!0:!1):(b.errorCallback(c,a.errorCall,"KGGetTSWithDigest"),p.call(e,d.seals[g.attr("index")],k,g.attr("index"),void 0,void 0,l?!0:!1))}):(b.errorCallback(c,a.errorCall,"KGGetTSWithDigest"),p.call(e,d.seals[g.attr("index")],k,g.attr("index"),void 0,void 0,l?!0:!1))})}else p.call(e,d.seals[g.attr("index")],
k,g.attr("index"),void 0,void 0,l?!0:!1);else return b.errorCallback(f,a.errorCall,"KGValidate_GM"),!1})}else if("client"==c.options.sealType&&b.keyData.seals[g.attr("index")].sealtag&&"GB"==b.keyData.seals[g.attr("index")].sealtag){t=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);var P=b.keyData.seals[g.attr("index")];t.invoke("KGVerifyGBSealAction",P.sesealinfo,P.signsn).ret(function(d){if(d.result)b.keyData.gbOvalue=d.ovalue,
p.call(e,P,k,g.attr("index"),void 0,void 0,l?!0:!1);else return b.errorCallback(d,a.errorCall,"KGVerifyGBSealAction"),!1})}else return g=e.find(".kg-wrapper .active"),e.isCheck=e.find("#kg-addDate").is(":checked"),void 0!=c.options.timestamp&&1==c.options.timestamp?"client"==c.options.sealType?(t=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode),t.invoke("KGGetTSURLInfo").ret(function(c){c.result?t.invoke("KGGetTSWithDigest",c.TimeStampUrl,
c.TimeStampUserName,c.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(c){c.result?p.call(e,d.seals[g.attr("index")],k,g.attr("index"),c.TimeStr,c):(b.errorCallback(c,a.errorCall,"KGGetTSWithDigest"),p.call(e,d.seals[g.attr("index")],k,g.attr("index")))}):(b.errorCallback(c,a.errorCall,"KGGetTSURLInfo"),p.call(e,d.seals[g.attr("index")],k,g.attr("index")))})):h.ajax({url:c.options.serverUrl+"_key_getTimeStamp",type:"POST",data:{keysn:b.keyData.keysn},async:!1,
success:function(a){a.result?p.call(e,d.seals[g.attr("index")],k,g.attr("index"),a.timestamp):p.call(e,d.seals[g.attr("index")],k,g.attr("index"))},error:function(a){p.call(e,d.seals[g.attr("index")],k,g.attr("index"))}}):p.call(e,d.seals[g.attr("index")],k,g.attr("index")),!1},content:function(){n.push(b.toBase64Img);var a=[c.options.template.showSealsBtl].concat(n);if(c.options.showNoPW||c.options.phoneshield)a=[c.options.template.showSealsBtl_nopassword].concat(n);return l.template.apply(null,
a)}};void 0!==q&&q&&(e=l.extend({onCancel:function(){void 0!==q&&q&&q.call(b);this.close()}},e));c.options.showNoPW||c.options.phoneshield?b.showDialog("showSealsBtl_nopassword",e):b.showDialog("showSealsBtl",e);c.options.showSignExpirePrompt&&null!=d.currenttime&&void 0!=d.currenttime&&null!=d.overdate&&void 0!=d.overdate&&(e=new Date(d.currenttime),g=Math.floor(((new Date(d.overdate)).getTime()-e.getTime())/864E5),g<=d.hintdays&&0<=g&&(localStorage.getItem("lastAlertDate")&&null!=localStorage.getItem("lastAlertDate")&&
""!=localStorage.getItem("lastAlertDate")?(f=localStorage.getItem("lastAlertDate"),f=new Date(f),0<e.getTime()-f.getTime()&&b.showExpirtDialog("\u5f53\u524d\u7528\u6237\u8fd8\u6709"+g+"\u5929\u8fc7\u671f\uff0c\u8bf7\u53ca\u65f6\u66f4\u65b0\uff01",d.currenttime)):b.showExpirtDialog("\u5f53\u524d\u7528\u6237\u8fd8\u6709"+g+"\u5929\u8fc7\u671f\uff0c\u8bf7\u53ca\u65f6\u66f4\u65b0\uff01",d.currenttime)))},showProtectedDataDialog:function(a,b,d){var e=[{newProData:d.newProItems,proItemsCheckedAll:b.protectedItemsCheckedAll}],
g={title:m.msg("ProtectedDataSet","KG_TITLE"),content:function(){e.push(l.html2Escape);var a=[c.options.template.protectedDataSetBtl].concat(e);return l.template.apply(null,a)},onOk:function(){for(var c=0;c<d.newProItems.length;c++)f.find("input[name='kg-proItem']").each(function(a,b){if(f.find("input[name='kg-proItem']")[a].checked&&h(this).val()==d.newProItems[c].field)return d.newProItems[c].isChecked=!0,!1;d.newProItems[c].isChecked=!1});var e=[];if(null!=b.protectedItemsType&&"1"==b.protectedItemsType)for(var g=
0;g<d.newProItems.length;g++)d.newProItems[g].isChecked&&e.push(d.newProItems[g]);else for(g=0;g<d.newProItems.length;g++)d.newProItems[g].isChecked&&e.push(d.newProItems[g].field);a.proItems=e}},f=v.showDialog("protectedDataSetBtl",g);f.find("#kg-proData-items").on("click",function(a){"LABEL"==a.target.tagName&&f.find("#kg-selectedProData").text(h(a.target).text().split("]")[1]);if("checkbox"==a.target.type)if(h(a.target).is(":checked")){a=!0;for(var d=f.find("input[name='kg-proItem']"),c=0;c<d.length;c++)if(!d[c].checked){a=
!1;break}a&&(f.find("input[name='selectAll']")[0].checked=!0,b.protectedItemsCheckedAll=!0)}else f.find("input[name='selectAll']")[0].checked=!1,b.protectedItemsCheckedAll=!1});f.find("#kg-selectBox").on("click",function(a){if(h(a.target).is(":checked")){b.protectedItemsCheckedAll=!0;a=f.find("input[name='kg-proItem']");for(var c=0;c<a.length;c++)a[c].checked=!0,d.newProItems[c].isChecked=!0}else for(b.protectedItemsCheckedAll=!1,a=f.find("input[name='kg-proItem']"),c=0;c<a.length;c++)a[c].checked=
!1,d.newProItems[c].isChecked=!1});return f},showFontDialog:function(a){var b=this,d=v.dafaultDate,e=null==b.signdate?{}:b.signdate,g=v.defaultFont;b=this;b=null==e.fontFormat?g.fontFormat:e.fontFormat;var f=null==e.fontFamily?g.fontFamily:e.fontFamily,k=null==e.fontSize?g.fontSize:e.fontSize,n=g.fontColor;null!=e.fontColor&&/^#([0-9a-fA-f]{6})$/.test(e.fontColor)&&(n=e.fontColor.toUpperCase());e=null==e.position?g.position:e.position;null!=a.fontSel&&(b=a.fontSel.fontFormat,f=a.fontSel.fontFamily,
k=a.fontSel.fontSize,n=a.fontSel.fontColor,e=v.fontTemplate.position[a.fontSel.fontPositionIndex]);var p=this.getArrayPush(c.options.fontTemplate.fontFormat,b),q=[{fontFormat:this.getFormatDate(p,d),fontFamily:this.getArrayPush(c.options.fontTemplate.fontFamily,f),fontSize:this.getArrayPush(c.options.fontTemplate.fontSize,k),fontColor:this.getArrayPush(c.options.fontTemplate.fontColor,n),fontPosition:c.options.fontTemplate.position,dFontFormat:m.Utils.formatDate(new Date(d),b),dFontFamily:f,dFontSize:k,
dFontColor:n,dFontPosition:e}];d={title:m.msg("DateSet","KG_TITLE"),content:function(){var a=[c.options.template.dateSetBtl].concat(q);return l.template.apply(null,a)},onOk:function(){var b=this.find("#kg-fontFormat").get(0).selectedIndex;a.fontSel={fontFormat:p[b],fontFamily:this.find("#kg-fontFamily").val(),fontSize:this.find("#kg-fontSize").val(),fontColor:m.Utils.colorHex(this.find("#kg-select-color").css("backgroundColor")),fontPositionIndex:this.find("#kg-fontPosition").get(0).selectedIndex}}};
var r=v.showDialog("dateSetBtl",d);r.find("#kg-select-color").on("click",function(){"block"==r.find(".kg-color-div").css("display")?(r.find(".kg-color-div").css("display","none"),r.find("#kg-color-ul").css("display","none")):(r.find(".kg-color-div").css("display","block"),r.find("#kg-color-ul").css("display","block"))});r.find("#kg-color-ul li a").click(function(){r.find("#kg-select-color").css("backgroundColor",h(this).css("backgroundColor"));r.find(".kg-color-div").css("display","none");r.find("#kg-color-ul").css("display",
"none")});r.find(".kg-color-div").on("mouseover",function(a){this.contains(a.fromElement||a.relatedTarget)||h(this).show()});r.find(".kg-color-div").on("mouseout",function(a){this.contains(a.toElement||a.relatedTarget)||h(this).hide()});return r},getArrayPush:function(a,b){-1==jQuery.inArray(b,a)&&a.push(b);return a},getFormatDate:function(a,b){for(var d=[],c=0;c<a.length;c++)d[c]=m.Utils.formatDate(new Date(b),a[c]);return d},genId:function(){var a=(new Date).getTime(),b=""+Math.ceil((9301*(new Date).getTime()+
49297)%233280/233280*99999),d=5-b.length;if(0<d)for(var c=0;c<d;c++)b="0"+b;return a+b},getSeal:function(a){return this.keyData.seals[a]},saveSignature:function(a,b,d,e){var g=this;void 0!=a&&void 0!=b&&void 0!=d&&(a=void 0!=c.options.cache_path&&null!=c.options.cache_path?{documentId:a,signatureId:b,signaturedata:d,cachepath:c.options.cache_path}:{documentId:a,signatureId:b,signaturedata:d,cachepath:""},m.surry(c.options.serverUrl).request("_signature_saveHtmlSignature",a).ret(function(a){void 0!==
e&&null!==e&&e.call(g,a)}))},removeSignature:function(a,b,d){var e=this;void 0!=a&&void 0!=b&&(a={documentId:a,signatureId:b},m.surry(c.options.serverUrl).request("_signature_reomveHtmlSignature",a).ret(function(a){void 0!==d&&null!==d&&d.call(e,a)}))},getSaveSignatures:function(a,b,d){void 0!=a&&m.surry(c.options.serverUrl).request("_signature_getHtmlSignature",{documentId:a}).ret(function(a){a.result?b(a.sign):d&&d(a.result)})},showExpirtDialog:function(a,b){v.showDialog("showExpirtDialog",{content:'<div class="kg-dialog kg-dialog-runSignature" id="sealExpirt-dialog"><div class="kg-dialog-content">'+
a+'</div><div ><input type="checkbox" name="noMorePrompts" id="kg-noMorePrompts">&nbsp;<label for="kg-noMorePrompts">\u4e0d\u518d\u63d0\u793a</label></div> </div>',onOk:function(){this.find("#kg-noMorePrompts").is(":checked")&&localStorage.setItem("lastAlertDate",b)},onCancel:function(){}})},getRPW:function(a){if(this.ongetRPW)return this.ongetRPW(a)}});h.extend(c.options,{certType:"client",sealType:"client",clientUrl:"http://127.0.0.1:9581",moveable:!0,signable:!0,fontTemplate:v.fontTemplate,template:{showSealsBtl:v.template.sealTpl,
showSealsBtl_nopassword:v.template.sealTpl_nopassword,signSignatureBtl:'<div id="kg-dialog-sign" class="kg-dialog kg-dialog-password kg-dialog-sign"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u5bc6\u7801\uff1a</label><div class="kg-sm kg-sm-7"> <input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div> </div></div></div>',revokeSignatureBtl:'<div id="kg-verifyPass" class="kg-dialog  kg-dialog-password"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u7b7e\u7ae0\uff1a</label><div class="kg-sm kg-sm-7"><p class="kg-form-static"><%this.signatureData.seal.signname%></p></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u5bc6\u7801\uff1a</label><div class="kg-sm kg-sm-7"> <input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div> </div></div></div>',
protectedDataSetBtl:'<div id="kg-setProData" class="kg-dialog "><div id="kg-pro-data" class="kg-sm-13 kg-dialog-proData "><% var newProData = this.newProData; %><% var isAllChecked = this.proItemsCheckedAll; %><div id="kg-proData-items" class="kg-dialog-proData-items"><% for(var i=0;i<newProData.length;i++){%><div class="kg-dialog-proData-item"><% var proId = "proItem"+i; %><% var filedd = newProData[i].desc && newProData[i].desc != "" ? newProData[i].desc : newProData[i].field; %><% var content = "[" + filedd+"]" + arguments[0](newProData[i].value); %><% if(newProData[i].isChecked){ %><input type="checkbox" checked name="kg-proItem" id="<% proId%>" value="<% newProData[i].field%>" class="kg-dialog-checkbox">&nbsp;<label class="kg-dialog-label" custom="pro-value"><% content%></label>&nbsp;<% } %><% else{ isAllChecked = false; %><input type="checkbox" name="kg-proItem" id="<% proId%>" value="<% newProData[i].field%>" class="kg-dialog-checkbox">&nbsp;<label class="kg-dialog-label"  custom="pro-value"><% content%></label>&nbsp;<% } %></div><%}%></div><div class="kg-dialog-line"></div><div class="kg-dialog-proData-selProData"><label id="kg-selectedProData" class="kg-selProData"></label></div></div><div ><% if(isAllChecked){ %><input type="checkbox" checked  name="selectAll" id="kg-selectBox"  class="kg-dialog-checkbox">&nbsp;<label class="kg-dialog-label" for="kg-selectBox" custom="pro-value">\u5168\u90e8\u9009\u4e2d</label>&nbsp;<% } else{ %><input type="checkbox"  name="selectAll" id="kg-selectBox"  class="kg-dialog-checkbox">&nbsp;<label class="kg-dialog-label" for="kg-selectBox" custom="pro-value">\u5168\u90e8\u9009\u4e2d</label>&nbsp;<% } %></div></div>',
dateSetBtl:'<div id="kg-setDate" class="kg-dialog kg-dialog-Date"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u683c\u5f0f\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontFormat" id="kg-fontFormat" class="kg-select kg-fontFormat"><% var fontFormat = this.fontFormat; %><% for(var i=0;i<fontFormat.length;i++) {%><% if(fontFormat[i] == this.dFontFormat){%><option class="kg-option" value="<% fontFormat[i]%>" selected><% fontFormat[i]%></option><%}else{%><option class="kg-option" value="<% fontFormat[i]%>"><% fontFormat[i]%></option><%}%><%}%></select></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u5b57\u4f53\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontFamily" id="kg-fontFamily" class="kg-select kg-fontFamily"><% var fontFamily = this.fontFamily; %><% for(var i=0;i<fontFamily.length;i++) {%><% if(fontFamily[i] == this.dFontFamily){%><option class="kg-option" value="<% fontFamily[i]%>" selected><% fontFamily[i]%></option><%}else{%><option class="kg-option" value="<% fontFamily[i]%>"><% fontFamily[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u5c3a\u5bf8\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontSize" id="kg-fontSize" class="kg-select kg-fontSize"><% var fontSize = this.fontSize; %><% for(var i=0;i<fontSize.length;i++) {%><% if(fontSize[i] == this.dFontSize){%><option class="kg-option" value="<% fontSize[i]%>" selected><% fontSize[i]%></option><%}else{%><option class="kg-option" value="<% fontSize[i]%>"><% fontSize[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u989c\u8272\uff1a</label><div class="kg-sm kg-sm-6"><% var fontColor = this.fontColor; %><div id="kg-select-color" class="kg-select-color" style="background-color:<% this.dFontColor%>"/><div class="kg-color-div"><ul class="kg-color-ul" id="kg-color-ul"><% for(var i=0;i<fontColor.length;i++){ %><li class="kg-color-li"><a href="javascript:;" style="background-color:<% fontColor[i]%>"></a></li><%}%></ul></div></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u4f4d\u7f6e\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontPosition" id="kg-fontPosition" class="kg-select kg-fontPosition"><% var fontPosition = this.fontPosition; %><% for(var i=0;i<fontPosition.length;i++) {%><% if(fontPosition[i] == this.dFontPosition){%><option class="kg-option" value="<% fontPosition[i]%>" selected><% fontPosition[i]%></option><%}else{%><option class="kg-option" value="<% fontPosition[i]%>"><% fontPosition[i]%></option><%}%><%}%></select></div> </div></div></div>'}});
c.list={};c.updateList=[];c.removeList=[];c.loadSignature=function(a,b,d,e){var g={};void 0==c.options.extra&&(c.options.extra={});g[a]=b;void 0!==g.extra&&null!==g.extra&&(c.options.extra[g.signatureid]=g.extra);r(g,d||function(a){c.verify()},e)};c.loadSignatures=function(a,b,d){var e={};void 0==c.options.extra&&(c.options.extra={});if(l.is("Array",a))for(var g=0;g<a.length;g++){var f=a[g];e[f.signatureid]=f.signatureData;void 0!==f.extra&&null!==f.extra&&(c.options.extra[f.signatureid]=f.extra)}else for(g in a)e[g]=
a[g];r(e,b||function(){c.verify()},d)};c.resetSignaturePos=function(a){void 0==c.options.extra&&(c.options.extra={});if(l.is("Array",a))for(var b=0;b<a.length;b++){var d=a[b];void 0!==d.extra&&null!==d.extra&&(c.options.extra[d.signatureid]=d.extra)}else for(b in a)c.options.extra[b]=a[b]};c.clearRPW=function(){var a=c.create();if(a.onDeleteRPW)a.onDeleteRPW()};var z=new n("Signature");c.addLiseter=function(a,b){z.on(a,b)};c.verify=function(){var a=c.list,b=[];z.trigger("beforeVerify",e);for(var d in a){var e=
a[d];e._verify(null,{batchVerify:!0})||b.push(e);z.trigger("eachVerify",e)}z.trigger("verify",e);return b};c.verifySignByList=function(a){var b=[];z.trigger("beforeVerify",c);for(var d in a){var c=a[d],g=c._verify(null,{batchVerify:!0}),f=c.signatureData,k={};k.appname=f.appname;k.documentid=f.documentid;k.documentname=f.documentname;k.keysn=f.keysn;k.orgname=f.orgname;k.timestamp=f.timestamp;k.usercode=f.usercode;k.username=f.username;k.signname=f.seal.signname;k.signsn=f.seal.signsn;g||(k.modifiedItems=
c.modifiedItems);b.push(k);z.trigger("eachVerify",c)}z.trigger("verify",c);return b};c.bind=function(a){l.extend(c.asyn,a)};c.show=function(){var a=c.list,b;for(b in a)a[b].show()};c.hide=function(){var a=c.list,b;for(b in a)a[b].hide()};c.AXI=function(a,b,d){c.authcode=f;var e=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode),g;for(g in b){var f=b[g];""!==g&&""!==f?e.invoke(a,g,f):null!==g&&""!==g?e.invoke(a,g):e.invoke(a)}e.ret(function(a){a.result&&
(c.options.moveable_self?(c.options.fjrsIsphone&&e.invoke("SetParamByName","FJRSISPHONE",c.options.fjrsIsphone),e.invoke("KGGetKeyOtherInfo","0").ret(function(b){b.result&&(b=b.Res.substring(1,b.Res.length-1),c.options.keysn=b);void 0!==d&&null!==d&&d(a)})):void 0!==d&&null!==d&&d(a))});return e};c.showAndHideBySignatureId=function(a,b){var d=c.list,e;for(e in d)0<=e.indexOf(a)&&(b?d[e].show():d[e].hide())};c.addIcon=function(a){var b=c.options.icons||[];b.push(a);c.options.icons=b};c.create=function(a){var b=
h.extend({},c.options,a);void 0!==a&&void 0!==a.imgtag&&(c.options.imgtag=a.imgtag);return new c._create(b)};h.extend(c.prototype,{saveSignatures:function(){},getSignatures:function(){}});n=function(a){var b=this;h.each(a,function(a,c){if("function"===typeof b[a])b[a](c);else b[a]=c})};l.inherit(n,c.SealService);w=function(a){var b=this;h.each(a,function(a,c){if("function"===typeof b[a])b[a](c);else b[a]=c})};l.inherit(w,c.CertService);h.extend(n.prototype,{saveLog:function(a){var b=[];l.is("Object",
a)?b.push(a):b=a;a=q({MSG:b});c.options.savelogFlg&&m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode).invoke("SetParamByName","SAVEMSG",a)},loadSeal:function(a){var b=this,d=a.successCall,e=a.errorCall,g=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);b.appcode?g.invoke("SetParamByName","APPCODE",b.appcode):b.appcode="";c.options.fjrsIsphone&&g.invoke("SetParamByName",
"FJRSISPHONE",c.options.fjrsIsphone);g.invoke("KGGetKeyInfo").ret(function(f){if(f.result){c.options.fjrsIsphone&&localStorage.setItem("fjrsToken",f.fjrs_token);c.options.phoneshield=!f.phoneshield||"1"!=f.phoneshield&&"3"!=f.phoneshield?!1:!0;c.options.phoneshield&&(m.options.timeout=1E3*(f.validatetime+10));if(""==f.seals)if(null!=a.data)f.seals={},f.seals[0]={signname:"",width:"",signsn:null,height:"",imgdata:"",imgext:".png"};else{e.call(b,{result:!1,errcode:"11"});return}else{if(void 0!==c.options.imgtag&&
null!==c.options.imgtag&&0!==c.options.imgtag){var g=[],h;for(h in f.seals){var l=f.seals[h];void 0!==l&&parseInt(l.imgtag)==c.options.imgtag&&(void 0!=f.fjrs_sealname?f.fjrs_sealname==f.seals[h].signname&&(g[g.length]=f.seals[h]):g[g.length]=f.seals[h])}f.seals=g}if(null!=c.options.signname){g=[];for(h in f.seals)l=f.seals[h],void 0!==l&&l.signname==c.options.signname&&(g[g.length]=f.seals[h]);0==g.length&&(f.result=!1,f.errcode="11101");f.seals=g}}d.call(b,f)}else e.call(b,f)})},verifyPwd:function(a){var b=
this,d=a.pwd,e=a.phoneshield?"1":"0",g=a.successCall;null==d&&(d="");var f=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);f.invoke("SetParamByName","ISPHONE",e);f.invoke("SetParamByName","FJRSISPHONE",a.phoneshield?a.phoneshield:"0");e&&f.invoke("SetParamByName","FJRSDELKEYSN",a.keysn);f.invoke("KGVerifyPin",d,a.keysn).ret(function(a){g.call(b,a)})},getKeysn:function(a,b){var d=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1",
"4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode),e=a&&a.key?a.key:"0";c.options.fjrsIsphone&&(d.invoke("SetParamByName","FJRSISPHONE",c.options.fjrsIsphone),d.invoke("SetParamByName","FJRSTOKEN",localStorage.getItem("fjrsToken")));d.invoke("KGGetKeyOtherInfo",e).ret(function(a){a.result?"0"==e?(a=a.Res.substring(1,a.Res.length-1),b(a)):b(a):v.alert(m.msg(a.errcode,"then"),function(){c.options.beginDlgOkCall&&c.options.beginDlgOkCall.call()},function(){c.options.beginDlgShowCall&&c.options.beginDlgShowCall.call()})})},
getPhoneShieldLic:function(a,b){var d=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);a.phoneshield&&"0"!=a.phoneshield&&d.invoke("SetParamByName","FJRSISPHONE",a.phoneshield);d.invoke("KGPhoneShieldLic").ret(function(a){b(a)})}});h.extend(w.prototype,{verifySign:function(a){var b=this,d=a.successCall,e=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);a.seal&&
a.seal.sealtag&&"GB"==a.seal.sealtag&&e.invoke("SetParamByName","GBSIGNSN",a.seal.signsn);c.options.fjrsIsphone&&e.invoke("SetParamByName","FJRSISPHONE",c.options.fjrsIsphone);e.invoke("KGVerifySignMessage","123456",a.signdata,a.signeddata).ret(function(c){var f=c.result||"-8"!==c.errcode?c:{result:!1};f.result&&a.seal&&"GB"==a.seal.sealtag?e.invoke("KGVerifyGBStampAction",a.signeddata).ret(function(a){a.result||(f={result:!1});d.call(b,f)}):d.call(b,f)});a.seal&&a.seal.sealtag&&"GB"==a.seal.sealtag&&
e.invoke("SetParamByName","GBSIGNSN","")},parseDate:function(a){var b=new Date;b.setFullYear(a.substring(0,4),+a.substring(4,6)-1,a.substring(6,8));b.setHours(a.substring(8,10),a.substring(10,12),a.substring(12,14),0);return b.getTime()},sign:function(a){var b=this,d=a.successCall,e=a.signMeta,g=[],f=[],k=a.seal,l=a.phoneshield?"1":"0";a=a.password;null==a&&(a="");for(var n=0;n<e.length;n++){var p=e[n];g.push(p.signdata);f.push(""+p.signdata.length)}e=m.surry(c.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1",
"4240FB41-A213-42B6-8CB5E6705C99B319",c.options.clientCode);e.invoke("SetParamByName","ISPHONE",l);k&&k.sealtag&&("GB"==k.sealtag&&(l=k.sesealinfo,e.invoke("SetParamByName","CLEARGBSESEALINFO",""),e.invoke("SetParamByName","GBSESEALINFO",l),e.invoke("SetParamByName","GBSIGNSN",k.signsn)),"GM"==k.sealtag&&e.invoke("SetParamByName","ISGM","1"));c.options.fjrsIsphone&&(e.invoke("SetParamByName","FJRSISPHONE",c.options.fjrsIsphone),e.invoke("SetParamByName","FJRSTOKEN",localStorage.getItem("fjrsToken")));
e.invoke("KGCrySignMessage",a,g.join(";"),+f[0]).ret(function(a){a=h.extend({},a);a.result&&(a.certinfo.notAfter=b.parseDate(a.certinfo.notAfter),a.certinfo.notBefore=b.parseDate(a.certinfo.notBefore));d.call(b,a)});k&&k.sealtag&&"GB"==k.sealtag&&(e.invoke("SetParamByName","CLEARGBSESEALINFO",""),e.invoke("SetParamByName","GBSIGNSN",""))}});c.addProvider("cert","client",w);c.addProvider("seal","client",n);n=function(a,b){var c=this;c.sData=b;h.each(a,function(a,b){if("function"===typeof c[a])c[a](b);
else c[a]=b})};l.inherit(n,c.SealService);var M=function(a,b){var c=this;c.sData=b;h.each(a,function(a,b){if("function"===typeof c[a])c[a](b);else c[a]=b})};l.inherit(M,c.CertService);h.extend(n.prototype,{getSealsUrl:"_key_load",verifyPwdUrl:"_key_verify",saveLogUrl:"_signature_saveLog",saveLog:function(a){a=q(a);c.options.savelogFlg&&m.surry(this.serverUrl).request(this.saveLogUrl,{loginfo:a}).ret(function(a){a.result||c.prototype.error.call(null,a)})},getPwdSaveTime:function(a,b){m.surry(c.options.serverUrl).request("_signature_getPwdSaveTime").ret(function(c){a(c.result?
c.pwdTime:b)})},loadSeal:function(a){var b=this,d=a.successCall,e=a.errorCall,g={usercode:b.usercode,keysn:b.keysn,signname:b.signname,authcode:b.authcode,password:c.options.password,sealTag:c.options.sealTag,certContext:c.options.cert};m.surry(b.serverUrl).request(b.getSealsUrl,g).ret(function(f){if(f.result){if(""==f.seals)if(null!=a.data)f.seals={},f.seals[0]={signname:"",width:"",signsn:null,height:"",imgdata:"",imgext:".png"};else{e.call(b,{result:!1,errcode:"11101"});return}else if(void 0!==
c.options.imgtag&&null!==c.options.imgtag&&0!==c.options.imgtag){var g=[],h;for(h in f.seals){var l=f.seals[h];void 0!==l&&parseInt(l.imgtag)==c.options.imgtag&&(g[g.length]=f.seals[h])}f.seals=g}d.call(b,f)}else e.call(b,f)})},verifyPwd:function(a){var b=this,c=a.successCall;a={usercode:void 0==b.sData?a.usercode:b.sData.usercode,keysn:void 0==b.sData?a.keysn:b.sData.keysn,password:a.pwd};m.surry(b.serverUrl).request(b.verifyPwdUrl,a).ret(function(a){c.call(b,a)})}});h.extend(M.prototype,{signUrl:"_sign",
verifySignUrl:"_sign_verify",verifySign:function(a){var b=this,c=b.sData,e=a.successCall;m.surry(b.serverUrl).request(b.verifySignUrl,{certType:c.certType,isUTF8:c.isUTF8,signsn:c.seal.signsn,html2sign:c.signMeta.html2sign,keysn:c.keysn,signdata:a.signdata,signeddata:c.signMeta.signeddata,crtdata:c.signMeta.certinfo.crtdata,sealTag:c.seal.sealTag}).ret(function(a){e.call(b,a)})},sign:function(a){for(var b=this,c=a.signMeta,e=a.successCall,g=[],f=a.seal.sealTag,h=0;h<c.length;h++){var l=c[h];"GM"==
f&&(l.hashAlg="SM3",l.encryptAlg="SM2");g.push("$"+(l.hashAlg||b.hashAlg)+"|"+(l.encryptAlg||b.encryptAlg)+"$"+l.signdata)}a={keysn:a.keysn,password:a.password,signdata:g.join(";"),signsn:a.signsn,sealTag:f};m.surry(b.serverUrl).request(b.signUrl,a).ret(function(a){a.result&&(a.certinfo.algName=a.certinfo.algName.replace("with",""));e.call(b,a)})}});c.addProvider("cert","server",M);c.addProvider("seal","server",n);c.alert=v.alert;var T=c.version={name:"1.0.20",code:100};return u.Signature=c});
// V2.0.0.400    
